name: Block SQL Files Unless Approved

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  check-sql-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Fetch base branch for comparison
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1

      - name: Check for .sql files in the PR
        id: sql_check
        run: |
          CHANGED_SQL_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }} HEAD | grep '\.sql$' || true)
          echo "SQL_FILES<<EOF" >> $GITHUB_ENV
          echo "$CHANGED_SQL_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          if [[ -n "$CHANGED_SQL_FILES" ]]; then
            echo "found_sql=true" >> $GITHUB_ENV
          else
            echo "found_sql=false" >> $GITHUB_ENV

      - name: Check if SQL files are allowed in PR body
        id: pr_body_check
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          echo "PR_BODY: $PR_BODY"
          if [[ "$PR_BODY" == *"- [x] Allow SQL files"* ]]; then
            echo "allow_sql=true" >> $GITHUB_ENV
          else
            echo "allow_sql=false" >> $GITHUB_ENV

      - name: Fail if SQL files are found but not approved
        run: |
          if [[ "$found_sql" == "true" && "$allow_sql" == "false" ]]; then
            echo "❌ SQL files detected, but approval task is not checked."
            echo "Please check '- [x] Allow SQL files' in the PR description if this is intentional."
            exit 1
          else
            echo "✅ Check passed."
